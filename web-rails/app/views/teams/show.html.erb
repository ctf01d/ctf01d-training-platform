<%= render @team %>

<div>
  <% if user_signed_in? && (current_user.role == 'admin' || can_manage_team?(@team)) %>
    <%= link_to "Редактировать", edit_team_path(@team) %> |
  <% end %>
  <%= link_to "Назад к командам", teams_path %>
  <% if user_signed_in? && (current_user.role == 'admin' || can_manage_team?(@team)) %>
    | <%= button_to "Удалить команду", @team, method: :delete, form: { style: 'display:inline' } %>
  <% end %>
</div>

<hr>
<h2>Участники</h2>
<div>
  <% memberships = @team.team_memberships.includes(:user) %>
  <% events = @team.membership_events.includes(:user, :actor).order(created_at: :desc).limit(20) %>
  <% if memberships.any? %>
    <table border="1" cellpadding="4" cellspacing="0">
      <tr>
        <th>Пользователь</th>
        <th>Роль</th>
        <th>Статус</th>
        <% if user_signed_in? && (current_user.role == 'admin' || can_manage_team?(@team)) %>
          <th>Действия</th>
        <% end %>
      </tr>
      <% memberships.each do |m| %>
        <tr>
          <td><%= link_to m.user.display_name, m.user %></td>
          <td><%= m.role %></td>
          <td><%= m.status %></td>
          <% if user_signed_in? && (current_user.role == 'admin' || can_manage_team?(@team)) %>
            <td>
              <% if m.status == 'pending' %>
                <%= button_to 'Одобрить', approve_team_membership_path(m), method: :post, form: { style: 'display:inline' } %>
                <%= button_to 'Отклонить', reject_team_membership_path(m), method: :post, form: { style: 'display:inline' } %>
              <% else %>
                Установить роль:
                <%= button_to 'owner', set_role_team_membership_path(m, role: 'owner'), method: :post, form: { style: 'display:inline' } %>
                <%= button_to 'captain', set_role_team_membership_path(m, role: 'captain'), method: :post, form: { style: 'display:inline' } %>
                <%= button_to 'vice_captain', set_role_team_membership_path(m, role: 'vice_captain'), method: :post, form: { style: 'display:inline' } %>
                <%= button_to 'player', set_role_team_membership_path(m, role: 'player'), method: :post, form: { style: 'display:inline' } %>
                <% unless m.role == 'owner' %>
                  | <%= button_to 'Удалить', team_membership_path(m), method: :delete, form: { style: 'display:inline', data: { turbo_confirm: 'Удалить участника?' } } %>
                <% end %>
              <% end %>
            </td>
          <% end %>
        </tr>
      <% end %>
    </table>
  <% else %>
    <p>Пока нет участников.</p>
  <% end %>

  <% if user_signed_in? && current_user.role == 'admin' %>
    <p><%= link_to 'Добавить участника', new_team_membership_path(team_id: @team.id) %></p>
  <% end %>

  <% if user_signed_in? %>
    <% existing = @team.team_memberships.find { |tm| tm.user_id == current_user.id } %>
    <% if existing.nil? || existing.status == 'rejected' %>
      <p style="margin-top: 12px;">
        <%= button_to 'Подать заявку в команду', join_request_team_path(@team), method: :post %>
      </p>
    <% elsif existing.status == 'pending' %>
      <p style="margin-top: 12px; color:#666;">Заявка в ожидании.
        <% if existing.user_id == current_user.id %>
          <%= button_to 'Принять', accept_team_membership_path(existing), method: :post, form: { style: 'display:inline' } %>
          <%= button_to 'Отклонить', decline_team_membership_path(existing), method: :post, form: { style: 'display:inline' } %>
        <% end %>
      </p>
    <% elsif existing.status == 'approved' %>
      <p style="margin-top: 12px; color:#666;">
        <%= button_to 'Покинуть команду', team_membership_path(existing), method: :delete, form: { style: 'display:inline', data: { turbo_confirm: 'Покинуть команду?' } } %>
      </p>
    <% end %>
  <% end %>

  <% if user_signed_in? && (current_user.role == 'admin' || can_manage_team?(@team)) %>
    <hr>
    <h3>Пригласить пользователя</h3>
    <%= form_with url: invite_team_path(@team), method: :post, local: true do |f| %>
      <%= label_tag :user_name, 'Логин пользователя' %>
      <%= text_field_tag :user_name, '', placeholder: 'user_login' %>
      <%= submit_tag 'Пригласить' %>
    <% end %>
  <% end %>

  <hr>
  <h3>История изменений</h3>
  <% if events.any? %>
    <ul>
      <% events.each do |e| %>
        <li>
          <small><%= l(e.created_at, format: :short) rescue e.created_at %></small> —
          <%= (e.actor&.display_name || 'Система') %>:
          <% case e.action
             when 'created' %>
               добавил(а) участника <%= e.user.display_name %> (роль: <%= e.to_role %>)
          <% when 'invited' %>
               пригласил(а) <%= e.user.display_name %>
          <% when 'join_requested' %>
               <%= e.user.display_name %> подал(а) заявку
          <% when 'approved' %>
               одобрил(а) заявку <%= e.user.display_name %>
          <% when 'rejected' %>
               отклонил(а) заявку <%= e.user.display_name %>
          <% when 'accepted' %>
               <%= e.user.display_name %> принял(а) приглашение
          <% when 'declined' %>
               <%= e.user.display_name %> отклонил(а) приглашение
          <% when 'role_changed' %>
               изменил(а) роль <%= e.user.display_name %> с <%= e.from_role || '-' %> на <%= e.to_role || '-' %>
          <% when 'removed' %>
               удалил(а) <%= e.user.display_name %> из команды
          <% when 'left' %>
               <%= e.user.display_name %> покинул(а) команду
          <% end %>
        </li>
      <% end %>
    </ul>
  <% else %>
    <p>Пока нет событий.</p>
  <% end %>
</div>
