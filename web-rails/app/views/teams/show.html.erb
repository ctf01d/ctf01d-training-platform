<%= render @team %>

<div>
  <%= link_to "Edit this team", edit_team_path(@team) %> |
  <%= link_to "Back to teams", teams_path %>

  <%= button_to "Destroy this team", @team, method: :delete %>
</div>

<hr>
<h2>Участники</h2>
<div>
  <% memberships = @team.team_memberships.includes(:user) %>
  <% if memberships.any? %>
    <table border="1" cellpadding="4" cellspacing="0">
      <tr>
        <th>Пользователь</th>
        <th>Роль</th>
        <th>Статус</th>
      </tr>
      <% memberships.each do |m| %>
        <tr>
          <td><%= link_to m.user.display_name, m.user %></td>
          <td><%= m.role %></td>
          <td><%= m.status %></td>
        </tr>
      <% end %>
    </table>
  <% else %>
    <p>Пока нет участников.</p>
  <% end %>

  <% if user_signed_in? && current_user.role == 'admin' %>
    <p><%= link_to 'Добавить участника', new_team_membership_path(team_id: @team.id) %></p>
  <% end %>

  <% if user_signed_in? && (current_user.role == 'admin' || can_manage_team?(@team)) %>
    <% @team.team_memberships.each do |m| %>
      <% if m.status == 'pending' %>
        <div style="margin-top: 6px;">
          Заявка: <%= m.user.display_name %> —
          <%= button_to 'Одобрить', approve_team_membership_path(m), method: :post, form: { style: 'display:inline' } %>
          <%= button_to 'Отклонить', reject_team_membership_path(m), method: :post, form: { style: 'display:inline' } %>
        </div>
      <% end %>
    <% end %>
  <% end %>

  <% if user_signed_in? %>
    <% existing = @team.team_memberships.find { |tm| tm.user_id == current_user.id } %>
    <% if existing.nil? || existing.status == 'rejected' %>
      <p style="margin-top: 12px;">
        <%= button_to 'Подать заявку в команду', join_request_team_path(@team), method: :post %>
      </p>
    <% elsif existing.status == 'pending' %>
      <p style="margin-top: 12px; color:#666;">Ваша заявка на рассмотрении.</p>
    <% end %>
  <% end %>
</div>
