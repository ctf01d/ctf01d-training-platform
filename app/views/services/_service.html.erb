<% condensed = local_assigns[:condensed] %>
<div id="<%= dom_id service %>" class="card">
  <div style="display:flex; align-items:center; gap:10px;" class="row">
    <%= avatar_image_tag(service.name, url: service.avatar_url) %>
    <div>
      <strong><%= link_to service.name, service %></strong>
      <% if service.public %>
        <span class="badge badge--green">public</span>
      <% else %>
        <span class="badge badge--gray">private</span>
      <% end %>
      <% if service.check_status.present? %>
        <% cls = case service.check_status
                 when 'ok' then 'badge--green'
                 when 'fail' then 'badge--red'
                 when 'queued' then 'badge--blue'
                 else 'badge--gray' end %>
        <span class="badge <%= cls %>">checker: <%= service.check_status %></span>
      <% end %>
    </div>
  </div>

  <p style="margin: 6px 0 0 0;" class="muted">
    <em><%= service.author %></em>
  </p>

  <div style="margin-top:8px;">
    <div><strong>Public description:</strong> <%= service.public_description %></div>
    <% if user_signed_in? && current_user.role == 'admin' %>
      <div style="margin-top:4px;" class="muted"><strong>Private:</strong> <%= service.private_description %></div>
    <% end %>
  </div>

  <% unless condensed %>
    <div style="margin-top:8px;">
      <% if service.service_archive_url.present? %>
        <div>Service archive: <%= link_to service.service_archive_url, service.service_archive_url, target: '_blank', rel: 'noopener' %></div>
      <% end %>
      <% if service.checker_archive_url.present? %>
        <div>Checker archive: <%= link_to service.checker_archive_url, service.checker_archive_url, target: '_blank', rel: 'noopener' %></div>
      <% end %>
      <% if service.writeup_url.present? %>
        <div>Writeup: <%= link_to service.writeup_url, service.writeup_url, target: '_blank', rel: 'noopener' %></div>
      <% end %>
      <% if service.exploits_url.present? %>
        <div>Exploits: <%= link_to service.exploits_url, service.exploits_url, target: '_blank', rel: 'noopener' %></div>
      <% end %>
    </div>

    <% if user_signed_in? && current_user.role == 'admin' %>
      <div style="margin-top:8px;">
        <strong>Локальные копии:</strong>
        <div class="muted">
          <% if service.service_local_path.present? %>
            <div>
              service.zip — <%= number_to_human_size(service.service_local_size || 0) %>, <%= l(service.service_downloaded_at, format: :short) rescue service.service_downloaded_at %>
              (<%= link_to 'скачать', download_local_service_path(service, what: 'service') %>)
            </div>
          <% else %>
            <div>service.zip — нет</div>
          <% end %>
          <% if service.checker_local_path.present? %>
            <div>
              checker.zip — <%= number_to_human_size(service.checker_local_size || 0) %>, <%= l(service.checker_downloaded_at, format: :short) rescue service.checker_downloaded_at %>
              (<%= link_to 'скачать', download_local_service_path(service, what: 'checker') %>)
            </div>
          <% else %>
            <div>checker.zip — нет</div>
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>

  <% if user_signed_in? && current_user.role == 'admin' && !condensed %>
    <div style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap;">
      <% if service.public %>
        <%= button_to 'Сделать приватным', toggle_public_service_path(service), method: :post, class: 'btn' %>
      <% else %>
        <%= button_to 'Сделать публичным', toggle_public_service_path(service), method: :post, class: 'btn' %>
      <% end %>
      <% if service.checker_archive_url.present? %>
        <%= button_to 'Проверить чекер', check_checker_service_path(service), method: :post, form: { style: 'display:inline' }, class: 'btn' %>
      <% end %>

      <% if service.service_archive_url.present? || service.checker_archive_url.present? %>
        <%= button_to 'Перескачать (оба)', redownload_service_path(service, what: 'both'), method: :post, class: 'btn' %>
      <% end %>
      <% if service.service_archive_url.present? %>
        <%= button_to 'Перескачать service.zip', redownload_service_path(service, what: 'service'), method: :post, class: 'btn' %>
      <% end %>
      <% if service.checker_archive_url.present? %>
        <%= button_to 'Перескачать checker.zip', redownload_service_path(service, what: 'checker'), method: :post, class: 'btn' %>
      <% end %>
    </div>
  <% end %>

</div>
