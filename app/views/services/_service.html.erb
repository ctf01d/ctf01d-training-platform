<% condensed = local_assigns[:condensed] %>
<div id="<%= dom_id service %>" class="card js-search-item" data-search="<%= [service.name, service.author, service.public_description].compact.join(' ').downcase %>">
  <div style="display:flex; align-items:center; gap:10px;" class="row">
    <%= avatar_image_tag(service.name, url: service.avatar_url) %>
    <div>
      <strong><%= link_to service.name, service %></strong>
      <% if service.public %>
        <span class="badge badge--green">public</span>
      <% else %>
        <span class="badge badge--gray">private</span>
      <% end %>
      <% if service.check_status.present? %>
        <% cls = case service.check_status
                 when 'codes', 'ok' then 'badge--green'
                 when 'missing', 'fail', 'error' then 'badge--red'
                 when 'present', 'queued' then 'badge--blue'
                 else 'badge--gray' end %>
        <% label = case service.check_status
                   when 'missing' then 'checker: нет'
                   when 'present' then 'checker: есть'
                   when 'codes' then 'checker: валидный'
                   else "check: #{service.check_status}" end %>
        <span class="badge <%= cls %>"><%= label %></span>
      <% end %>
    </div>
  </div>

  <p style="margin: 6px 0 0 0;" class="muted">
    <em><%= service.author %></em>
  </p>

  <div style="margin-top:8px;">
    <div><strong>Public description:</strong> <%= service.public_description %></div>
    <% if user_signed_in? && current_user.role == 'admin' %>
      <div style="margin-top:4px;" class="muted"><strong>Private:</strong> <%= service.private_description %></div>
    <% end %>
  </div>

  <% unless condensed %>
    <div style="margin-top:8px;">
      <% if service.service_archive_url.present? %>
        <div>Archive: <%= link_to service.service_archive_url, service.service_archive_url, target: '_blank', rel: 'noopener' %></div>
      <% end %>
      <% if service.writeup_url.present? %>
        <div>Writeup: <%= link_to service.writeup_url, service.writeup_url, target: '_blank', rel: 'noopener' %></div>
      <% end %>
      <% if service.exploits_url.present? %>
        <div>Exploits: <%= link_to service.exploits_url, service.exploits_url, target: '_blank', rel: 'noopener' %></div>
      <% end %>
    </div>

    <% if user_signed_in? && current_user.role == 'admin' %>
      <div style="margin-top:8px;">
        <strong>Локальные копии:</strong>
        <div class="muted">
          <% if service.service_local_path.present? %>
            <div>
              archive.zip — <%= number_to_human_size(service.service_local_size || 0) %>, <%= l(service.service_downloaded_at, format: :short) rescue service.service_downloaded_at %>
              (<%= link_to 'скачать', download_local_service_path(service) %>)
            </div>
          <% else %>
            <div>archive.zip — нет</div>
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>

  <% if user_signed_in? && current_user.role == 'admin' && !condensed %>
    <div style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap;">
      <% if service.public %>
        <%= button_to 'Сделать приватным', toggle_public_service_path(service), method: :post, class: 'btn' %>
      <% else %>
        <%= button_to 'Сделать публичным', toggle_public_service_path(service), method: :post, class: 'btn' %>
      <% end %>

      <% if service.service_archive_url.present? || service.service_local_path.present? %>
        <%= button_to 'Проверить', check_checker_service_path(service), method: :post, form: { style: 'display:inline' }, class: 'btn' %>
      <% end %>
      <% if service.service_archive_url.present? %>
        <%= button_to 'Перескачать архив', redownload_service_path(service), method: :post, class: 'btn' %>
      <% end %>
    </div>
  <% end %>

</div>
