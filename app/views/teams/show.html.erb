<div class="card" style="margin: 8px 0 16px;">
  <div class="row">
    <%= avatar_image_tag(@team.name, url: @team.avatar_url) %>
    <div>
      <p><strong><%= @team.name %></strong></p>
      <p class="muted">
        <%= @team.university ? link_to(@team.university.name, @team.university) : '' %>
        <% if @team.captain %> • Капитан: <%= link_to @team.captain.display_name, @team.captain %><% end %>
        • Участников: <%= @team.team_memberships.where(status: TeamMembership::STATUS_APPROVED).count %>
        • Соревнований: <%= @team.results.count %>
      </p>
      <% if @team.website.present? %>
        <p class="muted"><%= link_to @team.website, @team.website, target: '_blank', rel: 'noopener' %></p>
      <% end %>
    </div>
  </div>
</div>

<div>
  <% if user_signed_in? && (current_user.role == 'admin' || can_manage_team?(@team)) %>
    <%= link_to "Редактировать", edit_team_path(@team), class: 'btn' %> |
  <% end %>
  <%= link_to "Назад к командам", teams_path, class: 'btn' %>
  <% if user_signed_in? && (current_user.role == 'admin' || can_manage_team?(@team)) %>
    | <%= button_to "Удалить команду", @team, method: :delete, form: { style: 'display:inline' }, class: 'btn danger' %>
  <% end %>
</div>

<hr>
<h2>Участники</h2>
<div>
  <% memberships = @team.team_memberships.includes(:user) %>
  <% events = @team.membership_events.includes(:user, :actor).order(created_at: :desc).limit(20) %>
  <% if memberships.any? %>
    <table border="1" cellpadding="4" cellspacing="0">
      <tr>
        <th>Пользователь</th>
        <th>Роль</th>
        <th>Статус</th>
        <% if user_signed_in? && (current_user.role == 'admin' || can_manage_team?(@team)) %>
          <th>Действия</th>
        <% end %>
      </tr>
      <% memberships.each do |m| %>
        <tr>
          <td><%= link_to m.user.display_name, m.user %></td>
          <td><%= m.role %></td>
          <td><%= m.status %></td>
          <% if user_signed_in? && (current_user.role == 'admin' || can_manage_team?(@team)) %>
            <td>
              <% if m.status == TeamMembership::STATUS_PENDING %>
                <% if current_user.id != m.user_id %>
                  <%= button_to 'Одобрить', approve_team_membership_path(m), method: :post, form: { style: 'display:inline' } %>
                  <%= button_to 'Отклонить', reject_team_membership_path(m), method: :post, form: { style: 'display:inline' } %>
                <% else %>
                  <span style="color:#666;">(свою заявку одобрять нельзя — используйте кнопки ниже)</span>
                <% end %>
              <% else %>
                Установить роль:
                <%= button_to 'owner', set_role_team_membership_path(m, role: TeamMembership::ROLE_OWNER), method: :post, form: { style: 'display:inline' } %>
                <%= button_to 'captain', set_role_team_membership_path(m, role: TeamMembership::ROLE_CAPTAIN), method: :post, form: { style: 'display:inline' } %>
                <%= button_to 'vice_captain', set_role_team_membership_path(m, role: TeamMembership::ROLE_VICE_CAPTAIN), method: :post, form: { style: 'display:inline' } %>
                <%= button_to 'player', set_role_team_membership_path(m, role: TeamMembership::ROLE_PLAYER), method: :post, form: { style: 'display:inline' } %>
                <% unless m.role == TeamMembership::ROLE_OWNER %>
                  | <%= button_to 'Удалить', team_membership_path(m), method: :delete, form: { style: 'display:inline', data: { turbo_confirm: 'Удалить участника?' } } %>
                <% end %>
              <% end %>
            </td>
          <% end %>
        </tr>
      <% end %>
    </table>
  <% else %>
    <p>Пока нет участников.</p>
  <% end %>

  <% if user_signed_in? && current_user.role == 'admin' %>
    <p><%= link_to 'Добавить участника', new_team_membership_path(team_id: @team.id) %></p>
  <% end %>

  <% if user_signed_in? %>
    <% existing = @team.team_memberships.find { |tm| tm.user_id == current_user.id } %>
    <% if existing.nil? || existing.status == TeamMembership::STATUS_REJECTED %>
      <p style="margin-top: 12px;">
        <%= button_to 'Подать заявку в команду', join_request_team_path(@team), method: :post %>
      </p>
    <% elsif existing.status == TeamMembership::STATUS_PENDING %>
      <p style="margin-top: 12px; color:#666;">Заявка в ожидании.
        <% if existing.user_id == current_user.id %>
          <% last_event = @team.membership_events.where(user_id: current_user.id).order(created_at: :desc).first %>
          <% if last_event&.action == 'invited' %>
            <%= button_to 'Отклонить приглашение', decline_team_membership_path(existing), method: :post, form: { style: 'display:inline' } %>
          <% else %>
            <%= button_to 'Отозвать заявку', team_membership_path(existing), method: :delete, form: { style: 'display:inline', data: { turbo_confirm: 'Отозвать заявку?' } } %>
          <% end %>
        <% end %>
      </p>
    <% elsif existing.status == TeamMembership::STATUS_APPROVED %>
      <p style="margin-top: 12px; color:#666;">
        <%= button_to 'Покинуть команду', team_membership_path(existing), method: :delete, form: { style: 'display:inline', data: { turbo_confirm: 'Покинуть команду?' } } %>
      </p>
    <% end %>
  <% end %>

  <% if user_signed_in? && (current_user.role == 'admin' || can_manage_team?(@team)) %>
    <hr>
    <h3>Пригласить пользователя</h3>
    <%= form_with url: invite_team_path(@team), method: :post, local: true do |f| %>
      <%= label_tag :user_name, 'Логин пользователя' %>
      <%= text_field_tag :user_name, '', placeholder: 'user_login' %>
      <%= submit_tag 'Пригласить' %>
    <% end %>
  <% end %>

  <hr>
  <h3>История изменений</h3>
  <% if events.any? %>
    <ul>
      <% events.each do |e| %>
        <li>
          <small><%= l(e.created_at, format: :short) rescue e.created_at %></small> —
          <%= (e.actor&.display_name || 'Система') %>:
          <% case e.action
             when 'created' %>
               добавил(а) участника <%= e.user.display_name %> (роль: <%= e.to_role %>)
          <% when 'invited' %>
               пригласил(а) <%= e.user.display_name %>
          <% when 'join_requested' %>
               <%= e.user.display_name %> подал(а) заявку
          <% when 'approved' %>
               одобрил(а) заявку <%= e.user.display_name %>
          <% when 'rejected' %>
               отклонил(а) заявку <%= e.user.display_name %>
          <% when 'accepted' %>
               <%= e.user.display_name %> принял(а) приглашение
          <% when 'declined' %>
               <%= e.user.display_name %> отклонил(а) приглашение
          <% when 'role_changed' %>
               изменил(а) роль <%= e.user.display_name %> с <%= e.from_role || '-' %> на <%= e.to_role || '-' %>
          <% when 'removed' %>
               удалил(а) <%= e.user.display_name %> из команды
          <% when 'left' %>
               <%= e.user.display_name %> покинул(а) команду
          <% end %>
        </li>
      <% end %>
    </ul>
<% else %>
    <p>Пока нет событий.</p>
  <% end %>
</div>

<hr>
<h2>Участие в соревнованиях</h2>
<% participations = @team.results.includes(game: :final_results).order(score: :desc) %>
<% if participations.any? %>
  <table border="1" cellpadding="6" cellspacing="0">
    <tr>
      <th>Игра</th>
      <th>Очки</th>
      <th>Место (если зафиксировано)</th>
    </tr>
    <% participations.each do |r| %>
      <tr>
        <td><%= link_to r.game.name, r.game %></td>
        <td><%= r.score %></td>
        <% finalized = r.game.final_results.find { |fr| fr.team_id == r.team_id } %>
        <td><%= finalized&.position || '—' %></td>
      </tr>
    <% end %>
  </table>
<% else %>
  <p>Команда ещё не участвовала в соревнованиях.</p>
<% end %>

<hr>
<h2>Writeups команды</h2>
<% writeups = @team.writeups.includes(:game).order(created_at: :desc) %>
<% if writeups.any? %>
  <ul>
    <% writeups.each do |w| %>
      <li>
        <%= link_to(w.title, w.url, target: '_blank', rel: 'noopener') %>
        <span class="muted">— <%= link_to w.game.name, w.game %></span>
        <% if user_signed_in? && (current_user.role == 'admin' || can_manage_team?(@team)) %>
          | <%= button_to 'Удалить', writeup_path(w), method: :delete, form: { style: 'display:inline', data: { turbo_confirm: 'Удалить writeup?' } } %>
        <% end %>
      </li>
    <% end %>
  </ul>
<% else %>
  <p>Пока нет writeup’ов.</p>
<% end %>
