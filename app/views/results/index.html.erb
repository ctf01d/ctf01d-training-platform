<% content_for :title, "Результаты" %>

<h1>Результаты</h1>

<% if @games.any? %>
  <% @games.each do |game| %>
    <section class="section">
      <h2 style="margin: 0 0 8px 0;">
        <%= link_to game.name, game %>
        <% if game.starts_at.present? && game.ends_at.present? %>
          <small class="muted" style="font-weight: normal;">
            (<%= l(game.starts_at, format: :short) rescue game.starts_at %> — <%= l(game.ends_at, format: :short) rescue game.ends_at %>)
          </small>
        <% end %>
      </h2>
      <% results = game.results.includes(:team).sort_by { |r| -r.score.to_i } %>
      <% if results.any? %>
        <div class="card">
          <table class="table table-striped table--scores">
            <thead>
              <tr>
                <th>#</th>
                <th>Команда</th>
                <th>Очки</th>
                <% if user_signed_in? && current_user.role == 'admin' %>
                  <th>Действия</th>
                <% end %>
              </tr>
            </thead>
            <tbody>
              <% results.each_with_index do |r, idx| %>
                <tr>
                  <td><%= idx + 1 %></td>
                  <td>
                    <% if r.team %>
                      <%= avatar_image_tag(r.team.name, url: r.team.avatar_url, size: 28, class_name: 'avatar-image') %>
                      <%= link_to r.team.name, r.team, style: "margin-left:6px;" %>
                    <% else %>
                      — 
                    <% end %>
                  </td>
                  <td><%= r.score %></td>
                  <% if user_signed_in? && current_user.role == 'admin' %>
                    <td>
                      <%= link_to 'Редактировать', edit_result_path(r), class: 'btn' %>
                      <%= button_to 'Удалить', r, method: :delete, form: { style: 'display:inline', data: { turbo_confirm: 'Удалить результат?' } }, class: 'btn danger' %>
                    </td>
                  <% end %>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="card"><p class="muted" style="margin: 8px 10px;">Нет результатов.</p></div>
      <% end %>

      <% if user_signed_in? && current_user.role == 'admin' %>
        <div style="margin-top:8px;">
          <%= link_to 'Добавить результат', new_result_path(game_id: game.id), class: 'btn primary' %>
        </div>
      <% end %>
    </section>
  <% end %>
<% else %>
  <p>Пока нет игр.</p>
<% end %>
