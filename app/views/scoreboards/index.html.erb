<% content_for :title, "Скорбоард" %>

<% if @games.any? %>
  <% @games.each do |game| %>
    <section class="section">
      <h2 style="margin: 0 0 8px 0;">
        <%= link_to game.name, game %>
        <% if game.starts_at.present? && game.ends_at.present? %>
          <small class="muted" style="font-weight: normal;">
            (<%= l(game.starts_at, format: :short) rescue game.starts_at %> — <%= l(game.ends_at, format: :short) rescue game.ends_at %>)
          </small>
        <% end %>
      </h2>

      <% if game.final_results.any? %>
        <% results = game.final_results.includes(:team).sort_by { |r| [r.position || 0, -r.score.to_i] } %>
        <p class="muted" style="margin: 6px 0;">Итоги зафиксированы.</p>
      <% else %>
        <% results = game.results.includes(:team).sort_by { |r| -r.score.to_i } %>
      <% end %>

      <% if results.any? %>
        <div class="card">
          <table class="table table-striped table--scores">
            <thead>
              <tr>
                <th>#</th>
                <th>Команда</th>
                <th>Очки</th>
              </tr>
            </thead>
            <tbody>
              <% results.each_with_index do |r, idx| %>
                <tr>
                  <td><%= r.respond_to?(:position) && r.position ? r.position : (idx + 1) %></td>
                  <td>
                    <% if r.team %>
                      <%= avatar_image_tag(r.team.name, url: r.team.avatar_url, size: 28, class_name: 'avatar-image') %>
                      <%= link_to r.team.name, r.team, style: "margin-left:6px;" %>
                    <% else %>
                      —
                    <% end %>
                  </td>
                  <td><%= r.score %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="card"><p class="muted" style="margin: 8px 10px;">Нет результатов.</p></div>
      <% end %>
    </section>
  <% end %>
<% else %>
  <p>Пока нет игр.</p>
<% end %>
