<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "CTF01D" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="color-scheme" content="light dark">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag :app %>

    <script>
      (function() {
        const storageKey = "ctf01d-theme";
        let saved = null;
        try { saved = localStorage.getItem(storageKey); } catch (e) {}
        const preferred =
          window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches
            ? "dark"
            : "light";
        const theme = saved === "dark" || saved === "light" ? saved : preferred;
        document.documentElement.dataset.theme = theme;
      })();
    </script>
  </head>

  <body>
    <div class="navbar">
      <div class="container navbar-inner">
        <div class="brand">CTF01D</div>
        <%= link_to 'Сервисы', services_path %>
        <%= link_to 'Команды', teams_path %>
        <%= link_to 'Игры', games_path %>
        <%= link_to 'Скорбоарды', scoreboard_path %>
        <% if user_signed_in? && current_user.role == 'admin' %>
          <%= link_to 'Результаты', results_path %>
          <%= link_to 'Пользователи', users_path %>
          <%= link_to 'Университеты', universities_path %>
          <%= link_to 'Членства', team_memberships_path %>
        <% end %>
        <div class="spacer"></div>
        <button type="button" id="theme-toggle" class="btn btn-icon btn-icon--sm theme-toggle" aria-label="Переключить тему" aria-pressed="false">
          <svg class="theme-toggle__icon theme-toggle__icon--sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <circle cx="12" cy="12" r="4"></circle>
            <path d="M12 2v2"></path>
            <path d="M12 20v2"></path>
            <path d="m4.93 4.93 1.41 1.41"></path>
            <path d="m17.66 17.66 1.41 1.41"></path>
            <path d="M2 12h2"></path>
            <path d="M20 12h2"></path>
            <path d="m6.34 17.66-1.41 1.41"></path>
            <path d="m19.07 4.93-1.41 1.41"></path>
          </svg>
          <svg class="theme-toggle__icon theme-toggle__icon--moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M12 3a7 7 0 1 0 9 9 9 9 0 1 1-9-9z"></path>
          </svg>
        </button>
        <% if user_signed_in? %>
          <span class="navbar-auth">
            <span class="muted">Привет,</span><%= link_to current_user.display_name, profile_path %><span class="muted">(<%= current_user.role %>)</span>
          </span>
          <%= button_to 'Выйти', session_path, method: :delete, form: { style: 'display:inline' }, class: 'btn' %>
        <% else %>
          <%= link_to 'Войти', new_session_path, class: 'btn' %>
        <% end %>
      </div>
    </div>

    <div class="container">
      <% flash.each do |key, message| %>
        <p class="flash <%= key.to_s %>"><%= message %></p>
      <% end %>

      <%= yield %>
    </div>

    <script>
      // Простой фильтр по вводу: ищет по data-search или тексту элемента
      document.addEventListener('DOMContentLoaded', function() {
        const inputs = document.querySelectorAll('.js-search-input');
        inputs.forEach(function(input) {
          const targetSel = input.dataset.target;
          let items = [];
          if (targetSel) {
            const containers = Array.from(document.querySelectorAll(targetSel));
            if (containers.length > 0) {
              containers.forEach(function(c) {
                items = items.concat(Array.from(c.querySelectorAll('.js-search-item')));
              });
            } else {
              items = Array.from(document.querySelectorAll(targetSel));
            }
          } else {
            items = Array.from(document.querySelectorAll('.js-search-item'));
          }
          if (items.length === 0) { return; }

          items.forEach(function(el) {
            const txt = (el.dataset.search || el.textContent || '').toLowerCase();
            el.dataset.searchNormalized = txt;
          });

          const applyFilter = function() {
            const q = (input.value || '').trim().toLowerCase();
            items.forEach(function(el) {
              const match = q === '' || (el.dataset.searchNormalized && el.dataset.searchNormalized.includes(q));
              el.style.display = match ? '' : 'none';
            });
          };

          input.addEventListener('input', applyFilter);
        });

        // Дропдаун сервисов
        const dropdownToggle = document.getElementById('service-dropdown-toggle');
        const dropdownMenu = document.getElementById('service-dropdown-menu');
        if (dropdownToggle && dropdownMenu) {
          const hide = () => dropdownMenu.classList.remove('open');
          dropdownToggle.addEventListener('click', function(e) {
            e.preventDefault();
            dropdownMenu.classList.toggle('open');
          });
          document.addEventListener('click', function(e) {
            if (!dropdownMenu.contains(e.target) && !dropdownToggle.contains(e.target)) {
              hide();
            }
          });
        }

        // Тёмная тема
        const themeToggle = document.getElementById('theme-toggle');
        if (themeToggle) {
          const storageKey = 'ctf01d-theme';
          const root = document.documentElement;
          const sync = () => {
            const isDark = root.dataset.theme === 'dark';
            themeToggle.setAttribute('aria-pressed', isDark ? 'true' : 'false');
            themeToggle.setAttribute('title', isDark ? 'Тёмная тема' : 'Светлая тема');
          };

          sync();
          themeToggle.addEventListener('click', function() {
            const next = root.dataset.theme === 'dark' ? 'light' : 'dark';
            root.dataset.theme = next;
            try { localStorage.setItem(storageKey, next); } catch (e) {}
            sync();
          });
        }
      });
    </script>
  </body>
</html>
