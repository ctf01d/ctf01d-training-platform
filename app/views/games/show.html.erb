<div style="margin: 8px 0 16px;">
  <%= render @game %>
  <div style="margin-top:8px;">
    <% if user_signed_in? && current_user.role == 'admin' %>
      <%= link_to "Редактировать", edit_game_path(@game), class: 'btn' %> |
      <%= link_to "Сервисы игры", manage_services_game_path(@game), class: 'btn' %> |
      <%= link_to "Экспорт ctf01d", export_ctf01d_options_game_path(@game), class: 'btn' %> |
      <%= button_to "Удалить игру", @game, method: :delete, form: { style: 'display:inline' }, class: 'btn danger' %> |
    <% end %>
    <%= link_to "Назад к играм", games_path, class: 'btn' %>
  </div>
</div>

<div class="section">
  <h2 style="margin: 0 0 8px 0;">Команды</h2>

  <% if @game_teams.any? %>
    <div class="card">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Порядок</th>
            <th>Команда</th>
            <th>IP</th>
            <th>ctf01d_id</th>
            <th>ctf01d_*</th>
            <% if user_signed_in? && current_user.role == 'admin' %>
              <th>Действия</th>
            <% end %>
          </tr>
        </thead>
        <tbody>
          <% @game_teams.each do |gt| %>
            <% if user_signed_in? && current_user.role == 'admin' %>
              <%= form_with model: gt, url: game_team_path(gt), method: :patch, local: true, html: { style: 'display: contents;' } do |f| %>
                <tr>
                  <td><%= f.number_field :order, value: gt.order, style: 'width: 72px;' %></td>
                  <td>
                    <div>
                      <%= link_to(gt.team&.name || '—', gt.team || teams_path) %>
                      <%= team_type_badge(gt) %>
                    </div>
                    <div class="muted" style="margin-top:4px;">
                      <%= f.label :team_type, 'Тип (blue/red/...)', style: 'display:block; font-weight:normal;' %>
                      <%= f.text_field :team_type, value: gt.team_type, placeholder: 'blue', style: 'width: 160px;' %>
                    </div>
                  </td>
                  <td><%= f.text_field :ip_address, value: gt.ip_address, placeholder: '10.10.1.3', style: 'width: 160px;' %></td>
                  <td><%= f.text_field :ctf01d_id, value: gt.ctf01d_id, placeholder: 't01', style: 'width: 90px;' %></td>
                  <td>
                    <%= f.text_area :ctf01d_overrides_text, rows: 2, placeholder: "ctf01d_type: blue\nctf01d_flag: yes", style: 'width: 100%;' %>
                    <div class="muted" style="font-size:12px;">только ключи вида ctf01d_*</div>
                  </td>
                  <td>
                    <%= f.hidden_field :game_id, value: @game.id %>
                    <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
                      <%= f.submit 'Сохранить', class: 'btn primary' %>
                      <%= link_to 'Удалить', game_team_path(gt), data: { turbo_method: :delete, turbo_confirm: 'Убрать команду из игры?' }, class: 'btn danger' %>
                    </div>
                  </td>
                </tr>
              <% end %>
            <% else %>
              <% extra = (gt.ctf01d_overrides || {}).to_h.transform_keys(&:to_s) %>
              <% extra['ctf01d_type'] ||= gt.team_type if gt.team_type.present? %>
              <% extra.delete('ctf01d_id') %>
              <% extra.delete_if { |_k, v| v.to_s.strip.empty? } %>
              <tr>
                <td><%= gt.order %></td>
                <td>
                  <%= link_to(gt.team&.name || '—', gt.team || teams_path) %>
                  <%= team_type_badge(gt) %>
                </td>
                <td><%= gt.ip_address.presence || '—' %></td>
                <td><%= gt.ctf01d_id.presence || '—' %></td>
                <td><%= extra.any? ? extra.map { |k, v| "#{k}=#{v}" }.join(', ') : '—' %></td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div class="card"><p class="muted" style="margin: 8px 10px;">Команды пока не добавлены.</p></div>
  <% end %>

  <% if @new_game_team %>
    <div class="card" style="margin-top:8px;">
      <h3 style="margin-top:0;">Добавить команду</h3>
      <%= form_with model: @new_game_team, url: game_teams_path, method: :post, local: true, html: { class: 'form' } do |f| %>
        <%= f.hidden_field :game_id, value: @game.id %>
        <div class="form-group">
          <%= f.label :team_id, 'Команда' %>
          <% if @available_teams.any? %>
            <%= f.collection_select :team_id, @available_teams, :id, :name, include_blank: false %>
          <% else %>
            <p class="muted" style="margin: 0;">Свободных команд нет — все уже добавлены.</p>
          <% end %>
        </div>
        <div class="form-group" style="display:flex; gap:10px; flex-wrap:wrap;">
          <div>
            <%= f.label :order, 'Порядок' %><br>
            <%= f.number_field :order, value: (@new_game_team.order || @game_teams.size + 1), style: 'width: 100px;' %>
          </div>
          <div>
            <%= f.label :team_type, 'Тип' %><br>
            <%= f.text_field :team_type, placeholder: 'blue/red', style: 'width: 150px;' %>
          </div>
          <div>
            <%= f.label :ip_address, 'IP' %><br>
            <%= f.text_field :ip_address, placeholder: '10.10.1.3', style: 'width: 160px;' %>
          </div>
          <div>
            <%= f.label :ctf01d_id, 'ctf01d_id' %><br>
            <%= f.text_field :ctf01d_id, placeholder: 't01', style: 'width: 100px;' %>
          </div>
        </div>
        <div class="form-group">
          <%= f.label :ctf01d_overrides_text, 'Доп. поля ctf01d_*' %><br>
          <%= f.text_area :ctf01d_overrides_text, rows: 2, placeholder: "ctf01d_type: blue\nctf01d_flag: yes" %>
        </div>
        <div class="form-actions">
          <%= f.submit 'Добавить', class: 'btn primary', disabled: @available_teams.empty? %>
        </div>
      <% end %>
    </div>
  <% end %>
</div>

<div class="section">
  <h2 style="margin: 0 0 8px 0;">
    <% if @final %>Итоги (зафиксировано)<% else %>Результаты<% end %>
    <% if user_signed_in? && current_user.role == 'admin' %>
      <small style="font-weight:normal; margin-left:8px;">
        <% if @final %>
          <%= button_to 'Снять финализацию', unfinalize_game_path(@game), method: :delete, form: { style: 'display:inline' }, class: 'btn' %>
        <% else %>
          <%= button_to 'Зафиксировать итоги', finalize_game_path(@game), method: :post, form: { style: 'display:inline' }, class: 'btn' %>
        <% end %>
      </small>
    <% end %>
  </h2>

  <% if @results.any? %>
    <div class="card">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>#</th>
            <th>Команда</th>
            <th>Очки</th>
          </tr>
        </thead>
        <tbody>
          <% @results.each_with_index do |r, idx| %>
            <tr>
              <td><%= @final ? (r.position || idx + 1) : (idx + 1) %></td>
              <td>
                <% if r.team.present? %>
                  <%= link_to r.team.name, r.team %>
                  <% if (gt = @game_team_lookup[r.team_id]) %>
                    <%= team_type_badge(gt) %>
                  <% end %>
                <% else %>
                  — 
                <% end %>
              </td>
              <td><%= r.score %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div class="card"><p class="muted" style="margin: 8px 10px;">Пока нет результатов.</p></div>
  <% end %>
</div>

<% if user_signed_in? && current_user.role == 'admin' %>
  <p style="margin-top:8px;">
    <%= link_to 'Добавить результат', new_result_path(game_id: @game.id) %>
  </p>
<% end %>

<hr>
<h2>Доступ / Сети</h2>
<% if @game.vpn_url.present? || @game.vpn_config_url.present? || @game.access_instructions.present? %>
  <% if @can_access %>
    <div>
      <% if @game.vpn_url.present? %>
        <div><strong>VPN URL:</strong> <%= link_to @game.vpn_url, @game.vpn_url, target: '_blank', rel: 'noopener' %></div>
      <% end %>
      <% if @game.vpn_config_url.present? %>
        <div><strong>VPN config:</strong> <%= link_to @game.vpn_config_url, @game.vpn_config_url, target: '_blank', rel: 'noopener' %></div>
      <% end %>
      <% if @game.access_secret.present? %>
        <div><strong>Секрет/ключ:</strong> <code><%= @game.access_secret %></code></div>
      <% end %>
      <% if @game.access_instructions.present? %>
        <div style="margin-top:6px;"><strong>Инструкции:</strong><br><pre style="white-space:pre-wrap;"><%= @game.access_instructions %></pre></div>
      <% end %>
    </div>
  <% else %>
    <p class="muted">Доступ к сетям доступен только участникам игр (одобренные члены команд-участников).</p>
  <% end %>
<% else %>
  <p class="muted">Оргкомитет ещё не опубликовал информацию о доступе.
    <% if user_signed_in? && current_user.role == 'admin' %>
      — <%= link_to 'заполнить', edit_game_path(@game) %>
    <% end %>
  </p>
<% end %>

<hr>
<h2>Writeups</h2>
<% if @writeups.any? %>
  <table class="table table-striped">
    <tr>
      <th>Команда</th>
      <th>Заголовок</th>
      <th>Ссылка</th>
      <th></th>
    </tr>
    <% @writeups.each do |w| %>
    <tr>
      <td>
        <%= link_to(w.team&.name || '—', w.team || teams_path) %>
        <% if w.team && (gt = @game_team_lookup[w.team_id]) %>
          <%= team_type_badge(gt) %>
        <% end %>
      </td>
      <td><%= w.title %></td>
      <td><%= link_to w.url, w.url, target: '_blank', rel: 'noopener' %></td>
      <td>
          <% if user_signed_in? && (current_user.role == 'admin' || can_manage_team?(w.team)) %>
            <%= button_to 'Удалить', writeup_path(w), method: :delete, form: { style: 'display:inline', data: { turbo_confirm: 'Удалить writeup?' } } %>
          <% end %>
        </td>
      </tr>
    <% end %>
  </table>
<% else %>
  <p>Пока нет writeup’ов.</p>
<% end %>

<% if user_signed_in? && @my_manageable_teams.any? %>
  <div style="margin-top: 12px;">
    <h3>Добавить writeup</h3>
    <%= form_with url: writeups_path, method: :post, local: true do |f| %>
      <%= hidden_field_tag :game_id, @game.id %>
      <div style="margin-bottom:6px;">
        <%= label_tag :team_id, 'Ваша команда' %>
        <%= select_tag :team_id, options_from_collection_for_select(@my_manageable_teams, :id, :name), include_blank: false %>
      </div>
      <div style="margin-bottom:6px;">
        <%= label_tag :title, 'Заголовок' %>
        <%= text_field_tag :title, '', placeholder: 'Название writeup' %>
      </div>
      <div style="margin-bottom:6px;">
        <%= label_tag :url, 'Ссылка' %>
        <%= text_field_tag :url, 'https://', placeholder: 'https://…' %>
      </div>
      <%= submit_tag 'Добавить' %>
    <% end %>
  </div>
<% end %>
