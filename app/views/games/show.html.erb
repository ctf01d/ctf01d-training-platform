<div style="margin: 8px 0 16px;">
  <%= render @game %>
  <div style="margin-top:8px;">
    <% if user_signed_in? && current_user.role == 'admin' %>
      <%= link_to "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", edit_game_path(@game), class: 'btn' %> |
      <%= link_to "–°–µ—Ä–≤–∏—Å—ã –∏–≥—Ä—ã", manage_services_game_path(@game), class: 'btn' %> |
      <%= link_to "–≠–∫—Å–ø–æ—Ä—Ç ctf01d", export_ctf01d_options_game_path(@game), class: 'btn' %> |
      <%= button_to "–£–¥–∞–ª–∏—Ç—å –∏–≥—Ä—É", @game, method: :delete, form: { style: 'display:inline' }, class: 'btn danger' %> |
    <% end %>
    <%= link_to "–ù–∞–∑–∞–¥ –∫ –∏–≥—Ä–∞–º", games_path, class: 'btn' %>
  </div>
</div>

<div class="section">
  <h2 style="margin: 0 0 8px 0;">–ö–æ–º–∞–Ω–¥—ã</h2>

  <% if @game_teams.any? %>
    <div class="card">
      <table class="table table-striped game-teams-table">
        <thead>
          <tr>
            <th>–ü–æ—Ä—è–¥–æ–∫</th>
            <th>–ö–æ–º–∞–Ω–¥–∞</th>
            <th>–¢–∏–ø</th>
            <th>IP</th>
            <th>ctf01d_id</th>
            <th>
              ctf01d_*
              <% info = "–¢–æ–ª—å–∫–æ –∫–ª—é—á–∏ –≤–∏–¥–∞ ctf01d_*, –Ω–∞–ø—Ä–∏–º–µ—Ä ctf01d_type: blue" %>
              <span class="muted" title="<%= info %>" style="cursor: help;">?</span>
            </th>
            <% if user_signed_in? && current_user.role == 'admin' %>
              <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            <% end %>
          </tr>
        </thead>
        <tbody>
          <% @game_teams.each do |gt| %>
            <% if user_signed_in? && current_user.role == 'admin' %>
              <%= form_with model: gt, url: game_team_path(gt), method: :patch, local: true, html: { style: 'display: contents;' } do |f| %>
                <tr>
                  <td><%= f.number_field :order, value: gt.order, style: 'width: 100%;' %></td>
                  <td>
                    <div><%= link_to(gt.team&.name || '‚Äî', gt.team || teams_path) %></div>
                  </td>
                  <td>
                    <%= f.select :team_type,
                      options_for_select([['‚Äî', ''], ['blue', 'blue'], ['red', 'red'], ['guest', 'guest']], gt.team_type),
                      {}, { style: 'width: 100%; height: 44px;' } %>
                  </td>
                  <td><%= f.text_field :ip_address, value: gt.ip_address, placeholder: '10.10.1.3', style: 'width: 100%;' %></td>
                  <td><%= f.text_field :ctf01d_id, value: gt.ctf01d_id, placeholder: 't01', style: 'width: 100%;' %></td>
                  <td>
                    <%= f.text_area :ctf01d_overrides_text, rows: 1, placeholder: "ctf01d_type: blue", style: 'width: 100%; height: 44px;' %>
                  </td>
                  <td>
                    <%= f.hidden_field :game_id, value: @game.id %>
                    <div class="game-teams-actions">
                      <%= f.submit 'üíæ', class: 'btn primary btn-icon', title: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' %>
                      <%= link_to '‚úï', game_team_path(gt), data: { turbo_method: :delete, turbo_confirm: '–£–±—Ä–∞—Ç—å –∫–æ–º–∞–Ω–¥—É –∏–∑ –∏–≥—Ä—ã?' }, class: 'btn danger btn-icon', title: '–£–¥–∞–ª–∏—Ç—å' %>
                    </div>
                  </td>
                </tr>
              <% end %>
            <% else %>
              <% extra = (gt.ctf01d_overrides || {}).to_h.transform_keys(&:to_s) %>
              <% extra['ctf01d_type'] ||= gt.team_type if gt.team_type.present? %>
              <% extra.delete('ctf01d_id') %>
              <% extra.delete_if { |_k, v| v.to_s.strip.empty? } %>
              <tr>
                <td><%= gt.order %></td>
                <td><%= link_to(gt.team&.name || '‚Äî', gt.team || teams_path) %></td>
                <td><%= gt.team_type.presence || '‚Äî' %></td>
                <td><%= gt.ip_address.presence || '‚Äî' %></td>
                <td><%= gt.ctf01d_id.presence || '‚Äî' %></td>
                <td><%= extra.any? ? extra.map { |k, v| "#{k}=#{v}" }.join(', ') : '‚Äî' %></td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div class="card"><p class="muted" style="margin: 8px 10px;">–ö–æ–º–∞–Ω–¥—ã –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.</p></div>
  <% end %>

  <% if @new_game_team %>
    <div class="card" style="margin-top:8px;">
      <h3 style="margin-top:0;">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É</h3>
      <%= form_with model: @new_game_team, url: game_teams_path, method: :post, local: true, html: { class: 'form' } do |f| %>
        <%= f.hidden_field :game_id, value: @game.id %>
        <div class="form-group">
          <%= f.label :team_id, '–ö–æ–º–∞–Ω–¥–∞' %>
          <% if @available_teams.any? %>
            <%= f.collection_select :team_id, @available_teams, :id, :name, include_blank: false %>
          <% else %>
            <p class="muted" style="margin: 0;">–°–≤–æ–±–æ–¥–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –Ω–µ—Ç ‚Äî –≤—Å–µ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.</p>
          <% end %>
        </div>
        <div class="form-group" style="display:flex; gap:10px; flex-wrap:wrap;">
          <div>
            <%= f.label :order, '–ü–æ—Ä—è–¥–æ–∫' %><br>
            <%= f.number_field :order, value: (@new_game_team.order || @game_teams.size + 1), style: 'width: 100px;' %>
          </div>
          <div>
            <%= f.label :team_type, '–¢–∏–ø' %><br>
            <%= f.text_field :team_type, placeholder: 'blue/red', style: 'width: 150px;' %>
          </div>
          <div>
            <%= f.label :ip_address, 'IP' %><br>
            <%= f.text_field :ip_address, placeholder: '10.10.1.3', style: 'width: 160px;' %>
          </div>
          <div>
            <%= f.label :ctf01d_id, 'ctf01d_id' %><br>
            <%= f.text_field :ctf01d_id, placeholder: 't01', style: 'width: 100px;' %>
          </div>
        </div>
        <div class="form-group">
          <%= f.label :ctf01d_overrides_text, '–î–æ–ø. –ø–æ–ª—è ctf01d_*' %><br>
          <%= f.text_area :ctf01d_overrides_text, rows: 2, placeholder: "ctf01d_type: blue" %>
        </div>
        <div class="form-actions">
          <%= f.submit '–î–æ–±–∞–≤–∏—Ç—å', class: 'btn primary', disabled: @available_teams.empty? %>
        </div>
      <% end %>
    </div>
  <% end %>
</div>

<div class="section">
  <h2 style="margin: 0 0 8px 0;">
    <% if @final %>–ò—Ç–æ–≥–∏ (–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ)<% else %>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã<% end %>
    <% if user_signed_in? && current_user.role == 'admin' %>
      <small style="font-weight:normal; margin-left:8px;">
        <% if @final %>
          <%= button_to '–°–Ω—è—Ç—å —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—é', unfinalize_game_path(@game), method: :delete, form: { style: 'display:inline' }, class: 'btn' %>
        <% else %>
          <%= button_to '–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∏—Ç–æ–≥–∏', finalize_game_path(@game), method: :post, form: { style: 'display:inline' }, class: 'btn' %>
        <% end %>
      </small>
    <% end %>
  </h2>

  <% if @results.any? %>
    <div class="card">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>#</th>
            <th>–ö–æ–º–∞–Ω–¥–∞</th>
            <th>–û—á–∫–∏</th>
          </tr>
        </thead>
        <tbody>
          <% @results.each_with_index do |r, idx| %>
            <tr>
              <td><%= @final ? (r.position || idx + 1) : (idx + 1) %></td>
              <td>
                <% if r.team.present? %>
                  <%= link_to r.team.name, r.team %>
                  <% if (gt = @game_team_lookup[r.team_id]) %>
                    <%= team_type_badge(gt) %>
                  <% end %>
                <% else %>
                  ‚Äî
                <% end %>
              </td>
              <td><%= r.score %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div class="card"><p class="muted" style="margin: 8px 10px;">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.</p></div>
  <% end %>
</div>

<% if user_signed_in? && current_user.role == 'admin' %>
  <p style="margin-top:8px;">
    <%= link_to '–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç', new_result_path(game_id: @game.id) %>
  </p>
<% end %>

<hr>
<h2>–î–æ—Å—Ç—É–ø / –°–µ—Ç–∏</h2>
<% if @game.vpn_url.present? || @game.vpn_config_url.present? || @game.access_instructions.present? %>
  <% if @can_access %>
    <div>
      <% if @game.vpn_url.present? %>
        <div><strong>VPN URL:</strong> <%= link_to @game.vpn_url, @game.vpn_url, target: '_blank', rel: 'noopener' %></div>
      <% end %>
      <% if @game.vpn_config_url.present? %>
        <div><strong>VPN config:</strong> <%= link_to @game.vpn_config_url, @game.vpn_config_url, target: '_blank', rel: 'noopener' %></div>
      <% end %>
      <% if @game.access_secret.present? %>
        <div><strong>–°–µ–∫—Ä–µ—Ç/–∫–ª—é—á:</strong> <code><%= @game.access_secret %></code></div>
      <% end %>
      <% if @game.access_instructions.present? %>
        <div style="margin-top:6px;"><strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:</strong><br><pre style="white-space:pre-wrap;"><%= @game.access_instructions %></pre></div>
      <% end %>
    </div>
  <% else %>
    <p class="muted">–î–æ—Å—Ç—É–ø –∫ —Å–µ—Ç—è–º –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º –∏–≥—Ä (–æ–¥–æ–±—Ä–µ–Ω–Ω—ã–µ —á–ª–µ–Ω—ã –∫–æ–º–∞–Ω–¥-—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤).</p>
  <% end %>
<% else %>
  <p class="muted">–û—Ä–≥–∫–æ–º–∏—Ç–µ—Ç –µ—â—ë –Ω–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ—Å—Ç—É–ø–µ.
    <% if user_signed_in? && current_user.role == 'admin' %>
      ‚Äî <%= link_to '–∑–∞–ø–æ–ª–Ω–∏—Ç—å', edit_game_path(@game) %>
    <% end %>
  </p>
<% end %>

<hr>
<h2>Writeups</h2>
<% if @writeups.any? %>
  <table class="table table-striped">
    <tr>
      <th>–ö–æ–º–∞–Ω–¥–∞</th>
      <th>–ó–∞–≥–æ–ª–æ–≤–æ–∫</th>
      <th>–°—Å—ã–ª–∫–∞</th>
      <th></th>
    </tr>
    <% @writeups.each do |w| %>
    <tr>
      <td>
        <%= link_to(w.team&.name || '‚Äî', w.team || teams_path) %>
        <% if w.team && (gt = @game_team_lookup[w.team_id]) %>
          <%= team_type_badge(gt) %>
        <% end %>
      </td>
      <td><%= w.title %></td>
      <td><%= link_to w.url, w.url, target: '_blank', rel: 'noopener' %></td>
      <td>
          <% if user_signed_in? && (current_user.role == 'admin' || can_manage_team?(w.team)) %>
            <%= button_to '–£–¥–∞–ª–∏—Ç—å', writeup_path(w), method: :delete, form: { style: 'display:inline', data: { turbo_confirm: '–£–¥–∞–ª–∏—Ç—å writeup?' } } %>
          <% end %>
        </td>
      </tr>
    <% end %>
  </table>
<% else %>
  <p>–ü–æ–∫–∞ –Ω–µ—Ç writeup‚Äô–æ–≤.</p>
<% end %>

<% if user_signed_in? && @my_manageable_teams.any? %>
  <div style="margin-top: 12px;">
    <h3>–î–æ–±–∞–≤–∏—Ç—å writeup</h3>
    <%= form_with url: writeups_path, method: :post, local: true do |f| %>
      <%= hidden_field_tag :game_id, @game.id %>
      <div style="margin-bottom:6px;">
        <%= label_tag :team_id, '–í–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞' %>
        <%= select_tag :team_id, options_from_collection_for_select(@my_manageable_teams, :id, :name), include_blank: false %>
      </div>
      <div style="margin-bottom:6px;">
        <%= label_tag :title, '–ó–∞–≥–æ–ª–æ–≤–æ–∫' %>
        <%= text_field_tag :title, '', placeholder: '–ù–∞–∑–≤–∞–Ω–∏–µ writeup' %>
      </div>
      <div style="margin-bottom:6px;">
        <%= label_tag :url, '–°—Å—ã–ª–∫–∞' %>
        <%= text_field_tag :url, 'https://', placeholder: 'https://‚Ä¶' %>
      </div>
      <%= submit_tag '–î–æ–±–∞–≤–∏—Ç—å' %>
    <% end %>
  </div>
<% end %>
