<div style="margin: 8px 0 16px;">
  <%= render @game %>
  <div style="margin-top:8px;">
    <% if user_signed_in? && current_user.role == 'admin' %>
      <%= link_to "Редактировать", edit_game_path(@game), class: 'btn' %> |
      <%= link_to "Сервисы игры", manage_services_game_path(@game), class: 'btn' %> |
      <%= button_to "Удалить игру", @game, method: :delete, form: { style: 'display:inline' }, class: 'btn danger' %> |
    <% end %>
    <%= link_to "Назад к играм", games_path, class: 'btn' %> |
    <%= link_to "Таблица", scoreboard_path, class: 'btn' %>
  </div>
</div>

<div class="section">
  <h2 style="margin: 0 0 8px 0;">
    <% if @final %>Итоги (зафиксировано)<% else %>Результаты<% end %>
    <% if user_signed_in? && current_user.role == 'admin' %>
      <small style="font-weight:normal; margin-left:8px;">
        <% if @final %>
          <%= button_to 'Снять финализацию', unfinalize_game_path(@game), method: :delete, form: { style: 'display:inline' }, class: 'btn' %>
        <% else %>
          <%= button_to 'Зафиксировать итоги', finalize_game_path(@game), method: :post, form: { style: 'display:inline' }, class: 'btn' %>
        <% end %>
      </small>
    <% end %>
  </h2>

  <% if @results.any? %>
    <div class="card">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>#</th>
            <th>Команда</th>
            <th>Очки</th>
          </tr>
        </thead>
        <tbody>
          <% @results.each_with_index do |r, idx| %>
            <tr>
              <td><%= @final ? (r.position || idx + 1) : (idx + 1) %></td>
              <td><%= r.team&.name || '—' %></td>
              <td><%= r.score %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div class="card"><p class="muted" style="margin: 8px 10px;">Пока нет результатов.</p></div>
  <% end %>
</div>

<% if user_signed_in? && current_user.role == 'admin' %>
  <p style="margin-top:8px;">
    <%= link_to 'Добавить результат', new_result_path(game_id: @game.id) %>
  </p>
<% end %>

<hr>
<h2>Доступ / Сети</h2>
<% if @game.vpn_url.present? || @game.vpn_config_url.present? || @game.access_instructions.present? %>
  <% if @can_access %>
    <div>
      <% if @game.vpn_url.present? %>
        <div><strong>VPN URL:</strong> <%= link_to @game.vpn_url, @game.vpn_url, target: '_blank', rel: 'noopener' %></div>
      <% end %>
      <% if @game.vpn_config_url.present? %>
        <div><strong>VPN config:</strong> <%= link_to @game.vpn_config_url, @game.vpn_config_url, target: '_blank', rel: 'noopener' %></div>
      <% end %>
      <% if @game.access_secret.present? %>
        <div><strong>Секрет/ключ:</strong> <code><%= @game.access_secret %></code></div>
      <% end %>
      <% if @game.access_instructions.present? %>
        <div style="margin-top:6px;"><strong>Инструкции:</strong><br><pre style="white-space:pre-wrap;"><%= @game.access_instructions %></pre></div>
      <% end %>
    </div>
  <% else %>
    <p class="muted">Доступ к сетям доступен только участникам игр (одобренные члены команд-участников).</p>
  <% end %>
<% else %>
  <p class="muted">Оргкомитет ещё не опубликовал информацию о доступе.
    <% if user_signed_in? && current_user.role == 'admin' %>
      — <%= link_to 'заполнить', edit_game_path(@game) %>
    <% end %>
  </p>
<% end %>

<hr>
<h2>Writeups</h2>
<% if @writeups.any? %>
  <table border="1" cellpadding="6" cellspacing="0">
    <tr>
      <th>Команда</th>
      <th>Заголовок</th>
      <th>Ссылка</th>
      <th></th>
    </tr>
    <% @writeups.each do |w| %>
      <tr>
        <td><%= link_to(w.team&.name || '—', w.team || teams_path) %></td>
        <td><%= w.title %></td>
        <td><%= link_to w.url, w.url, target: '_blank', rel: 'noopener' %></td>
        <td>
          <% if user_signed_in? && (current_user.role == 'admin' || can_manage_team?(w.team)) %>
            <%= button_to 'Удалить', writeup_path(w), method: :delete, form: { style: 'display:inline', data: { turbo_confirm: 'Удалить writeup?' } } %>
          <% end %>
        </td>
      </tr>
    <% end %>
  </table>
<% else %>
  <p>Пока нет writeup’ов.</p>
<% end %>

<% if user_signed_in? && @my_manageable_teams.any? %>
  <div style="margin-top: 12px;">
    <h3>Добавить writeup</h3>
    <%= form_with url: writeups_path, method: :post, local: true do |f| %>
      <%= hidden_field_tag :game_id, @game.id %>
      <div style="margin-bottom:6px;">
        <%= label_tag :team_id, 'Ваша команда' %>
        <%= select_tag :team_id, options_from_collection_for_select(@my_manageable_teams, :id, :name), include_blank: false %>
      </div>
      <div style="margin-bottom:6px;">
        <%= label_tag :title, 'Заголовок' %>
        <%= text_field_tag :title, '', placeholder: 'Название writeup' %>
      </div>
      <div style="margin-bottom:6px;">
        <%= label_tag :url, 'Ссылка' %>
        <%= text_field_tag :url, 'https://', placeholder: 'https://…' %>
      </div>
      <%= submit_tag 'Добавить' %>
    <% end %>
  </div>
<% end %>
