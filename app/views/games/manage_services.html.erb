<% content_for :title, "Сервисы игры: #{@game.name}" %>

<h1>Сервисы игры: <%= @game.name %></h1>

<p>
  <%= link_to 'Назад к игре', @game, class: 'btn' %>
</p>

<%
  attached = @services.select { |s| @attached_ids.include?(s.id) }
  available = @services.reject { |s| @attached_ids.include?(s.id) }

  status_badge = ->(service) do
    next nil unless service.check_status.present?
    cls = case service.check_status
    when 'codes', 'ok' then 'badge--green'
    when 'missing', 'fail', 'error' then 'badge--red'
    when 'present', 'queued' then 'badge--blue'
    else 'badge--gray'
    end
    label = case service.check_status
            when 'missing' then 'checker: нет'
            when 'present' then 'checker: есть'
            when 'codes' then 'checker: валидный'
            else "checker: #{service.check_status}"
            end
    content_tag(:span, label, class: "badge #{cls}", style: "margin-left:6px;")
  end
%>

<div class="section">
  <h2 style="margin:0 0 8px 0;">Сервисы в игре (<%= attached.size %>)</h2>
  <% if attached.any? %>
    <div class="list">
      <% attached.each do |svc| %>
        <div class="card" style="display:flex; flex-direction:column; gap:8px;">
          <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start;">
            <div>
              <div style="display:flex; align-items:center; gap:6px; flex-wrap:wrap;">
                <strong><%= link_to svc.name, svc %></strong>
                <span class="badge <%= svc.public ? 'badge--green' : 'badge--gray' %>"><%= svc.public ? 'public' : 'private' %></span>
                <% if svc.respond_to?(:language) && svc.language.present? %>
                  <span class="badge badge--blue"><%= svc.language %></span>
                <% end %>
                <%= status_badge.call(svc) %>
              </div>
              <% if svc.author.present? %>
                <div class="muted" style="margin-top:2px;"><em><%= svc.author %></em></div>
              <% end %>
              <% if svc.public_description.present? %>
                <div class="muted" style="margin-top:6px; font-size:14px;"><%= truncate(svc.public_description, length: 140) %></div>
              <% end %>
            </div>
            <div>
              <%= button_to 'Убрать', remove_service_game_path(@game, service_id: svc.id), method: :delete, class: 'btn danger' %>
            </div>
          </div>
          <% if svc.service_archive_url.present? %>
            <div class="muted" style="font-size:13px;">Репозиторий: <%= link_to svc.service_archive_url, svc.service_archive_url, target: '_blank', rel: 'noopener' %></div>
          <% end %>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="card"><p class="muted" style="margin:0;">Пока нет прикреплённых сервисов.</p></div>
  <% end %>
</div>

<div class="section">
  <h2 style="margin:0 0 8px 0;">Доступные (<%= available.size %>)</h2>
  <% if available.any? %>
    <div class="list">
      <% available.each do |svc| %>
        <div class="card" style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px;">
          <div>
            <div style="display:flex; align-items:center; gap:6px; flex-wrap:wrap;">
              <strong><%= link_to svc.name, svc %></strong>
              <span class="badge <%= svc.public ? 'badge--green' : 'badge--gray' %>"><%= svc.public ? 'public' : 'private' %></span>
              <% if svc.respond_to?(:language) && svc.language.present? %>
                <span class="badge badge--blue"><%= svc.language %></span>
              <% end %>
                <%= status_badge.call(svc) %>
            </div>
            <% if svc.public_description.present? %>
              <div class="muted" style="margin-top:6px; font-size:14px;"><%= truncate(svc.public_description, length: 140) %></div>
            <% end %>
          </div>
          <div>
            <%= button_to 'Добавить', add_service_game_path(@game, service_id: svc.id), method: :post, class: 'btn primary' %>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="card"><p class="muted" style="margin:0;">Все сервисы уже в игре.</p></div>
  <% end %>
</div>
