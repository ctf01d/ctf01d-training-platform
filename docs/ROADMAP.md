# MVP - версия #2 (протопит на Ruby on Rails)

## Авторизация и профили

- Готово:
  - Сессии, роли (guest/player/admin), админ‑CRUD пользователей.
  - Профиль пользователя (просмотр/редактирование display_name, avatar_url, смена пароля).
  - "Мои команды": список членств с ролями и быстрыми действиями (выйти/отозвать заявку).
- Осталось:
  - Более тонкая матрица доступов по ролям (закрыть разделы за авторизацией, не только CRUD админа).
  - Регистрация по приглашению/одобрению админом.
  - Расширенный профиль: навыки, описание, контакты.

## Команды

- Готово:
  - CRUD, заявка на вступление, приглашение по логину, accept/decline, approve/reject.
  - Промоут/демоут ролей (owner/captain/vice_captain/player), капитан уникален в пределах команды.
  - Капитан назначается создателю при создании команды; управление участниками у менеджеров команды.
  - Университет нормализован (FK `teams.university_id`), формы с селектом.
  - История изменений состава/ролей (аудит‑лог действий) — события создаются и отображаются на странице команды и в профиле.
  - Глобальное ограничение: один пользователь может быть капитаном только в одной команде (валидация + уникальный индекс).
- Осталось:
  - Отдельная страница управления для владельца команды (центр управления).

## Университеты

- Готово:
  - Нормализация связи, обратные связи, базовые страницы.
- Осталось:
  - Доп. поля (страна/город), фильтры по странам/университетам, соцссылки.

## Сервисы (каталог)

- Готово:
  - Публичный список и фильтр `public`, аватар/инициал, admin‑CRUD.
  - Переключатель публичности, приватное описание только для админов.
  - Поля ссылок: архив сервиса, архив чекера, writeup; кнопка "Проверить чекер" (заглушка).
  - Рейтинг сервиса, дополнительные метаданные/копирайт.
- Осталось:
  - Валидация/скачивание/версионирование архивов (версии сервисов/чекеров).
  - Загрузка файлов (не только URL), хранение и проверка.
  - Полный flow интеграции с жюри (см. JURY_AND_SERVICE): сборка образов, docker‑compose, статусы проверок.

## Игры / Результаты / Scoreboard

- Готово:
  - CRUD игр, результаты; уникальность пары (game, team).
  - Мини‑таблицы результатов в `games#show` и на `/results`, публичный Scoreboard.
  - Статусы игр: разделение на Upcoming / Ongoing / Past и бейджи статуса.
  - Снимок итогов: финализация игры с immutable‑копией результатов (FinalResult), Scoreboard показывает snapshot при наличии.
  - Writeups к играм — готово: модель game+team+title+url, добавление с правами менеджера команды, списки в игре и на странице команды.
  - Планирование игр — готово: окна регистрации и видимости Таблицы (открыто/скоро/закрыто), отображение в списках и форме.
- Осталось:
  - Доступ/сети для участников (VPN и пр.).
 - Вес/нормализация очков для общего рейтинга команд (CTFtime‑подобная логика).

## Дополнительные требования (ROADMAP)

- Готово:
  - Процесс принятия в команду через подтверждение.
  - Управление ролями в командах.
- Осталось:
  - Workflow согласований (админы подтверждают изменения).
  - Историческая информация и метаданные (события/действия/состояния) — частично (есть аудит‑лог команд).

## Предлагаемые приоритеты (быстрые и заметные)

1. Ограничение капитанства: запрет "капитан только в одной команде".
2. Снимок итогов: флаг завершения + immutable‑копия результатов и вывод на Таблицу.
3. Writeups: модель и UI в игре/команде.
4. Сервисы: базовая валидация URL, поле `exploits_url`, бейджи статуса проверки (заглушка), скрыть Results гостям — готово.

## Синк 20.12.2025

## Режимы игры и расписание
- [ ] Скорборд: скрыть/отключить, оставить результаты и экспорт.
- [ ] Freeze: сделать опциональным режимом, включается/отключается на уровне игры/экспорта.
- [ ] LunchTime: слот поддерживается и в играх, и в экспорте CTF01d; его можно добавить/не добавлять, но при наличии он уходит в архив.

## Команды
- [x] Управление командами на странице игры: добавление/редактирование, ручной порядок (`order`), ручной ввод IP, кастомные параметры `ctf01d_*`, флаг/тип команды (blue и т.п.) рядом с доступами/райтапами/результатами.
- [ ] Хранить аватарки команд локально (загрузка в форме, сохранение и отображение).

## Экспорт
- [ ] Экспорт CTF01d сохраняет порядок команд, кастомные поля и IP; учитывает LunchTime при наличии.
- [ ] В UI экспорта печатать список команд и позволять управлять стартовым IP/шаблоном адресов.

## Импорт сервисов
- [ ] В корень репозитория сервиса кладём мета-файл `ctf01d-training-platform.json` (name, description, lang, port, прочая meta) + кнопка «скачать шаблон» в админке.
- [ ] Импорт из GitHub: сначала читаем мета-файл, при его отсутствии падаем на парсинг README.
- [x] Импорт ZIP: принимаем один архив и гоняем через тот же пайплайн, что GitHub (одинаковые проверки и разбиение на сервис/чекер).

## UI/UX и документация
- [ ] Экран игры: объединить работу с сервисами/командами/доступами/райтапами; выбор сервисов — из списка.
- [ ] Документация: описать контракт мета-файла, процесс импорта GitHub/ZIP, требования к командам и связь с форматом журейки (`data/config.yml` из 2025-cybersibir-jury).

## Синк 20.12.2025

- Добавить к итогам/результатам игры “мету”: описание, комментарии, медиа (скриншоты/графики, First Blood и т.п.).
- Сделать удобный порядок команд в игре: не только ввод числа, но и “вверх/вниз” (или другое быстрое управление порядком).
- Добавить порядок (order) для сервисов игры и гарантировать стабильный порядок в экспорте “из экспорта в экспорт”.
- Убрать из config.yml в экспортируемом YAML строку --- (у собеседника самописный YAML-парсер и он на это ругается).
- Доделать/стабилизировать импорты и экспорты (в т.ч. обработка ошибок, повторные попытки/предсказуемость).
- (Опционально) Сделать JSON-ответы/JSON API там, где сейчас HTML, если понадобится для интеграций.
- Сделать экспорт/импорт команд “как сущностей” пачкой (чтобы не вводить “50 команд каждый раз”); в расшифровке звучит “CVE”, но по смыслу это про CSV/файл обмена.
- Продумать “прединсталляцию” (seed/инициализация) команд/универов + картинок так, чтобы на свежей установке всё было.
- Идея: отдельный GitHub-репозиторий со списком команд (JSON/YAML + картинки) и импорт команд из него.
- Для локального запуска: оформить docker compose так, чтобы сохранялся стейт между рестартами, и добавить .gitignore/.dockerignore для локальных данных; локально HTTPS
не нужен.

# Безопасность

Аудит безопасности (bundle audit, brakeman, code review) — **в целом хорошо**, но есть улучшения:

**Высокий приоритет:**
- [ ] Rate limiting на логин (защита от brute force)
- [ ] Усилить валидацию GitHub URL в `GithubImporter` (текущая проверка `end_with?("github.com")` уязвима)

**Средний приоритет:**
- [ ] Timing attack на логине: `User.find_by(...)&.authenticate` — быстрее отвечает для несуществующих юзеров
- [ ] Явная CSRF защита: добавить `protect_from_forgery` в `ApplicationController`

**Низкий приоритет:**
- [ ] Включить Content Security Policy (сейчас закомментирован)
- [ ] Ограничить время жизни сессии (`expire_after`)

**Уже защищено:**
- SQL-инъекции (ActiveRecord + strong parameters)
- XSS (Rails default escaping)
- Mass Assignment (`params.expect()`)
- Open Redirect
- SSL в production (`force_ssl = true`)


# MVP - версия #1 (версия на go - не реализованная)

## Общее

- [ ] Авторизация
    - [x] Сессии в БД
    - [ ] Закрыть странички за авторизацию
- [x] Регистрация
    - [x] Через админку будет добавление новых пользователей
- [x] База данных (Postgres)
    - [x] Переехать с MySQL на PostgreSQL
    - [x] Добавить seed
    - [x] Версионирование для облегчения обновлений сервера
    - [x] Сделать изменения через миграции, а не init.sql
- [x] CI/CD
    - [x] Линтер
    - [x] Проверка зависимостей Nancy
    - [x] Сборка контейнера и отправка в registry

## Админка

- [x] Пользователи
    - [x] Создание
    - [x] Редактирование
    - [x] Удаление
- [x] Команды
    - [x] Создание
    - [x] Редактирование
    - [x] Удаление
- [x] Сервисы
    - [x] Создание
    - [x] Редактирование
    - [x] Удаление
- [ ] Игры
    - [x] Создание
    - [ ] По расписанию (какие сервисы, какие команды и когда)
    - [ ] При загрузке zip для сервиса необходимо проверить корректность работы чекера (проверить все коды и состояния)
- [ ] Результаты
    - [x] Создание
    - [ ] Редактирование
    - [x] Удаление

## Профиль пользователя

- [x] Информация о команде (командах), в которой находится пользователь
- [x] История по командам (в каких был и сколько)

## Сервисы

- [x] Отображение списка сервисов (которые разрешено показывать публике)
- [x] Автор, логотип
- [ ] Возможность скачать zip, райтапы

## Команды

- [x] Отображение списка команд
- [x] По команде - аватарка, университет, ссылки на социальные сети, краткое описание
- [ ] Текущий капитан (и его зам и зам зам капитана)
- [ ] Управление списком членов команды владельцем команды
- [ ] Возможность владельца команды приглашать пользователей в команду
- [x] Возможность пользователей подавать заявки на вступление в команду
- [ ] Ведение истории команды (создание, изменения состава, слияния и т.д.)

## Игры

- [ ] Список кто с кем и когда
- [ ] Когда игру открывают - доступ (например, через OpenVPN) для соответствующих команд и пользователей
- [ ] Должен быть scoreboard
- [ ] По завершению игры - сохранение результата scoreboard

## Дополнительные требования

- [ ] Процесс принятия в команду через подтверждение
- [ ] Возможность обновления аватарки и информации о себе пользователем
- [ ] Управление ролями в командах
- [ ] Возможность админам подтверждать изменения
- [ ] Ведение исторической информации и метаданных (события, действия, состояния)
- [ ] Страница для владельца команды с управлением членами команды и приглашениями



